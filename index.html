<!DOCTYPE html>
<html lang="mn">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Attendance</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">

    <!-- LOGIN -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center px-4">
        <div class="bg-white w-full max-w-sm p-6 rounded-2xl shadow">
            <h1 class="text-xl font-semibold text-center mb-6">üì± –ù—ç–≤—Ç—Ä—ç—Ö</h1>
            <input id="phoneInput" type="tel" placeholder="–£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä"
                class="w-full p-3 border rounded-xl mb-4 text-lg" />
            <button onclick="login()" class="w-full bg-blue-600 text-white py-3 rounded-xl text-lg">
                –ù—ç–≤—Ç—Ä—ç—Ö
            </button>
            <p id="loginError" class="hidden text-red-500 text-center mt-3">–£—Ç–∞—Å –æ–ª–¥—Å–æ–Ω–≥“Ø–π</p>
        </div>
    </div>

    <!-- APP -->
    <div id="appPage" class="hidden max-w-md mx-auto p-4 space-y-4">

        <!-- Header -->
        <div class="flex justify-between items-center">
            <div>
                <p id="userName" class="font-semibold text-lg"></p>
                <p id="userGroup" class="text-sm text-gray-500"></p>
            </div>
            <button onclick="logout()" class="text-red-500 text-sm">–ì–∞—Ä–∞—Ö</button>
        </div>

        <!-- Mode -->
        <div class="flex gap-2">
            <button id="btnDay" onclick="setMode('day')"
                class="flex-1 py-2 rounded-xl bg-blue-600 text-white">”®–¥”©—Ä</button>
            <button id="btnWeek" onclick="setMode('week')" class="flex-1 py-2 rounded-xl bg-gray-200">7 —Ö–æ–Ω–æ–≥</button>
            <button id="btnMonth" onclick="setMode('month')" class="flex-1 py-2 rounded-xl bg-gray-200">–°–∞—Ä</button>
        </div>

        <!-- Controls -->
        <div class="bg-white p-4 rounded-2xl shadow space-y-3">

            <input id="dateDay" type="date" class="w-full p-3 border rounded-xl" onclick="this.showPicker?.()" />
            <input id="dateWeek" type="date" class="hidden w-full p-3 border rounded-xl"
                onclick="this.showPicker?.()" />
            <input id="dateMonth" type="month" class="hidden w-full p-3 border rounded-xl"
                onclick="this.showPicker?.()" />

            <input id="groupInput" type="number" class="w-full p-3 border rounded-xl" />

            <button onclick="loadAttendance()" class="w-full bg-blue-600 text-white py-3 rounded-xl">
                –•–∞—Ä–∞—Ö
            </button>
        </div>

        <!-- Week calendar -->
        <div id="weekCalendar" class="hidden grid grid-cols-7 gap-1 text-center text-xs"></div>

        <!-- Result -->
        <div id="result" class="space-y-3"></div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbyNhXSZIr5YHR-iZ_bpNqZneL61EKOrtJJlwcj43GmTjiYyGf_rgmUha7_cosGWxgCgcg/exec";
        let viewMode = "day";

        /* LOGIN */
        function login() {
            const phone = phoneInput.value.trim();
            fetch(`${API_URL}?action=login&phone=${phone}`)
                .then(r => r.json())
                .then(u => {
                    if (!u.success) return loginError.classList.remove("hidden");
                    localStorage.setItem("user", JSON.stringify(u));
                    showApp();
                });
        }
        function logout() { localStorage.clear(); location.reload(); }

        /* INIT */
        function showApp() {
            const u = JSON.parse(localStorage.getItem("user"));
            loginPage.classList.add("hidden");
            appPage.classList.remove("hidden");
            userName.innerText = u.name;
            userGroup.innerText = "–ê—Ä–∞–≤—Ç: " + u.group;

            groupInput.value = u.group;
            if (u.group !== 0) groupInput.disabled = true;
        }
        window.onload = () => localStorage.getItem("user") && showApp();

        /* MODE */
        function setMode(m) {
            viewMode = m;
            ["day", "week", "month"].forEach(x => {
                document.getElementById("btn" + x[0].toUpperCase() + x.slice(1))
                    .className = "flex-1 py-2 rounded-xl " + (x === m ? "bg-blue-600 text-white" : "bg-gray-200");
            });

            dateDay.classList.add("hidden");
            dateWeek.classList.add("hidden");
            dateMonth.classList.add("hidden");
            weekCalendar.classList.add("hidden");

            if (m === "day") dateDay.classList.remove("hidden");
            if (m === "week") { dateWeek.classList.remove("hidden"); weekCalendar.classList.remove("hidden"); }
            if (m === "month") dateMonth.classList.remove("hidden");
        }

        /* WEEK CALENDAR */
        function renderWeekCalendar(monday) {
            weekCalendar.innerHTML = "";
            for (let i = 0; i < 7; i++) {
                const d = new Date(monday);
                d.setDate(d.getDate() + i);
                const ds = d.toISOString().slice(0, 10);
                weekCalendar.innerHTML += `
      <button class="bg-gray-100 rounded p-1 hover:bg-blue-100"
        onclick="loadDay('${ds}')">
        ${ds.slice(5)}
      </button>`;
            }
        }
        function loadDay(date) {
            viewMode = "day"; setMode("day");
            dateDay.value = date;
            loadAttendance();
        }

        /* LOAD */
        function loadAttendance() {
            const group = groupInput.value || 0;
            let date = "";

            if (viewMode === "day") date = dateDay.value;
            if (viewMode === "week") {
                date = dateWeek.value;
                if (new Date(date).getDay() !== 1) return alert("–î–∞–≤–∞–∞ —Å–æ–Ω–≥–æ–Ω–æ —É—É");
                renderWeekCalendar(date);
            }
            if (viewMode === "month") date = dateMonth.value + "-01";
            if (!date) return alert("–û–≥–Ω–æ–æ —Å–æ–Ω–≥–æ–Ω–æ —É—É");

            const action =
                viewMode === "day" ? "attendanceByDay" :
                    viewMode === "week" ? "attendanceByWeek" :
                        "attendanceByMonth";

            fetch(`${API_URL}?action=${action}&date=${date}&group=${group}`)
                .then(r => r.json())
                .then(d => viewMode === "day" ? renderDay(d) : renderSummary(d));
        }

        /* RENDER */
        function renderDay(rows) {
            result.innerHTML = "";
            rows.forEach(r => {
                result.innerHTML += `
      <div class="bg-white p-3 rounded-xl shadow">
        <div class="flex justify-between">
          <div>
            <p class="font-medium">${r.name}</p>
            <p class="text-xs text-gray-500">–ê—Ä–∞–≤—Ç ${r.group}</p>
          </div>
          <b>${r.times.length}</b>
        </div>
        <div class="flex gap-1 mt-1">${r.times.map(t => `<span class="bg-blue-100 px-2 rounded">${t}</span>`).join("")}</div>
      </div>`;
            });
        }
        function renderSummary(rows) {
            result.innerHTML = "";
            rows.forEach(r => {
                result.innerHTML += `
      <div class="bg-white p-3 rounded-xl shadow flex justify-between">
        <div>
          <p class="font-medium">${r.name}</p>
          <p class="text-xs text-gray-500">–ê—Ä–∞–≤—Ç ${r.group}</p>
        </div>
        <b>${r.count}</b>
      </div>`;
            });
        }
    </script>

</body>

</html>