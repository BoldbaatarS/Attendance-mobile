<!DOCTYPE html>
<html lang="mn">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Attendance</title>

    <!-- PWA -->
    <link rel="manifest" href="/manifest.json" />
    <meta name="theme-color" content="#2563eb" />

    <!-- iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <link rel="apple-touch-icon" href="/icons/icon-192.png" />

    <!-- Tailwind -->
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<script>
    if ("serviceWorker" in navigator) {
        navigator.serviceWorker.register("/sw.js");
    }
</script>


<body class="bg-gray-100 min-h-screen">

    <div class="max-w-md mx-auto p-4 space-y-4">
        <h1 class="text-xl font-semibold text-center">üìä –ò—Ä—Ü</h1>

        <!-- Date -->
        <button onclick="openSheet()"
            class="w-full h-14 rounded-2xl bg-white border px-4 text-left flex justify-between items-center">
            <span id="dateText" class="text-gray-400">–û–≥–Ω–æ–æ —Å–æ–Ω–≥–æ—Ö</span>
            <span>üìÖ</span>
        </button>

        <!-- Group -->
        <input id="group" type="number" class="w-full h-14 rounded-2xl border px-4 text-lg"
            placeholder="–ê—Ä–∞–≤—Ç (0 = –±“Ø–≥–¥)" value="0">

        <button onclick="loadData()" class="w-full h-14 rounded-2xl bg-blue-600 text-white text-lg">
            –•–∞—Ä–∞—Ö
        </button>

        <div id="result" class="space-y-3"></div>
    </div>

    <!-- Bottom Sheet -->
    <div id="backdrop" onclick="closeSheet()" class="fixed inset-0 bg-black/40 hidden"></div>

    <div id="sheet" class="fixed bottom-0 left-0 right-0 bg-white rounded-t-3xl p-5 translate-y-full transition">
        <input type="date" id="realDate" class="w-full h-14 rounded-2xl border px-4" onchange="selectDate(this.value)">
    </div>
    <div id="login" class="min-h-screen flex items-center justify-center">
        <div class="bg-white p-6 rounded-xl w-full max-w-sm shadow">
            <h2 class="text-xl font-semibold text-center mb-4">üì± –ù—ç–≤—Ç—Ä—ç—Ö</h2>

            <input id="phone" class="w-full p-3 border rounded-lg mb-4" placeholder="–£—Ç–∞—Å–Ω—ã –¥—É–≥–∞–∞—Ä"
                inputmode="numeric" />

            <button onclick="login()" class="w-full bg-blue-600 text-white p-3 rounded-lg">
                –ù—ç–≤—Ç—Ä—ç—Ö
            </button>

            <p id="loginError" class="text-red-500 text-sm mt-2 hidden">
                –£—Ç–∞—Å –æ–ª–¥—Å–æ–Ω–≥“Ø–π
            </p>
        </div>
    </div>

    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbwZqnbMgzb3qRrbQPLVZYH15MP2mW-LLZX-7q_v_n7rOWQYq3qznsA-zGbQBl6mPiArMw/exec";

        let selectedDate = null;

        function openSheet() {
            backdrop.classList.remove('hidden');
            sheet.classList.remove('translate-y-full');
        }
        function closeSheet() {
            backdrop.classList.add('hidden');
            sheet.classList.add('translate-y-full');
        }
        function selectDate(v) {
            selectedDate = v;
            dateText.innerText = v;
            dateText.className = 'text-gray-900';
            closeSheet();
        }
        function login() {
            const phone = document.getElementById("phone").value.trim();
            if (!phone) return;

            fetch(`${API}?action=login&phone=${phone}`)
                .then(r => r.json())
                .then(res => {
                    if (res.error) {
                        document.getElementById("loginError").classList.remove("hidden");
                        return;
                    }

                    localStorage.setItem("user", JSON.stringify(res));
                    showApp();
                });
        }

        async function loadData() {
            if (!selectedDate) return alert("–û–≥–Ω–æ–æ —Å–æ–Ω–≥–æ–Ω–æ —É—É");
            const group = document.getElementById('group').value || 0;

            result.innerHTML = '–ê—á–∞–∞–ª–∂ –±–∞–π–Ω–∞...';

            const res = await fetch(`${API_URL}?date=${selectedDate}&group=${group}`);
            const rows = await res.json();

            result.innerHTML = '';
            if (!rows.length) {
                result.innerHTML = '<div class="text-gray-400 text-center">–ú—ç–¥—ç—ç–ª—ç–ª –∞–ª–≥–∞</div>';
                return;
            }

            rows.forEach(r => {
                result.innerHTML += `
      <div class="bg-white rounded-2xl p-4 shadow">
        <div class="font-semibold">${r.name}</div>
        <div class="text-sm text-gray-500">‚è± ${r.times.join(', ')}</div>
      </div>`;
            });
        }
    </script>

</body>

</html>